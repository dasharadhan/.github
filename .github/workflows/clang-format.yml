name: clang-format

on:
  workflow_call:
    inputs:
      version:
        description: "clang-format version (e.g., 19)"
        required: false
        default: "19"
        type: string

permissions:
  contents: read
  pull-requests: write # required for PR comments

jobs:
  clang-format:
    runs-on: ubuntu-latest

    steps:
      # Prevent infinite CI loops:
      - name: Skip if triggered by bot
        if: ${{ github.actor == 'github-actions[bot]' || github.actor == 'github-actions' }}
        run: echo "Skipping to prevent CI loop" && exit 0

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install clang-format
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-format-${{ inputs.version }}
          ln -sf /usr/bin/clang-format-${{ inputs.version }} /usr/local/bin/clang-format

      - name: Install colordiff
        run: sudo apt-get install -y colordiff

      - name: Run clang-format checks
        id: clang
        continue-on-error: true
        run: |
          # Disable exit on error
          set +e 

          FILES=$(git ls-files '*.c' '*.cc' '*.cpp' '*.cxx' '*.h' '*.hpp')
          FAILED=0

          echo "" > clang-format.patch
          echo "" > clang-format.txt

          for file in $FILES; do
            diff_output=$(clang-format "$file" | diff -u "$file" - || true)

            if [[ -n "$diff_output" ]]; then
              echo "::error file=$file::clang-format issues detected"

              # Show colored diff in logs only
              echo -e "$diff_output" | colordiff || true

              # Save raw diff (no color) for PR comment
              echo -e "$diff_output" >> clang-format.txt

              # Save patch
              clang-format "$file" | diff -u "$file" - >> clang-format.patch

              FAILED=1
            fi
          done

          echo "failed=$FAILED" >> "$GITHUB_OUTPUT"

      - name: Upload patch artifact
        if: steps.clang.outputs.failed == '1'
        uses: actions/upload-artifact@v4
        with:
          name: clang-format.patch
          path: clang-format.patch

      - name: Comment on PR with diff
        if: ${{ steps.clang.outputs.failed == '1' && github.event_name == 'pull_request' }}
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require("fs");
            const diffText = fs.readFileSync("clang-format.txt", "utf8");

            if (diffText.trim().length === 0) {
              return;
            }

            const body =
              `#### clang-format issues detected\n` +
              `A formatting patch has been uploaded as an artifact.\n\n` +
              `#### Diff:\n` +
              `\`\`\`diff\n${diffText}\n\`\`\``;

            // Delete previous comments made by this workflow
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            for (const comment of comments) {
              if (
                comment.user.type === "Bot" &&
                comment.body &&
                comment.body.includes("clang-format issues detected")
              ) {
                await github.rest.issues.deleteComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: comment.id
                });
              }
            }

            // Post new updated comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });

      - name: Fail job if necessary
        if: steps.clang.outputs.failed == '1'
        run: exit 1
