name: clang-format

on:
  workflow_call:
    inputs:
      version:
        description: "clang-format version (e.g., 19)"
        required: false
        default: "19"
        type: string

permissions:
  contents: read
  pull-requests: write # required for PR comments

jobs:
  clang-format:
    runs-on: ubuntu-latest

    steps:
      # Prevent infinite CI loops:
      - name: Skip if triggered by bot
        if: ${{ github.actor == 'github-actions[bot]' || github.actor == 'github-actions' }}
        run: echo "Skipping to prevent CI loop" && exit 0

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install clang-format
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-format-${{ inputs.version }}
          ln -sf /usr/bin/clang-format-${{ inputs.version }} /usr/local/bin/clang-format

      - name: Install colordiff
        run: sudo apt-get install -y colordiff

      - name: Run clang-format checks
        id: clang
        continue-on-error: true
        run: |
          # Disable exit on error
          set +e 

          FILES=$(git ls-files '*.c' '*.cc' '*.cpp' '*.cxx' '*.h' '*.hpp')
          FAILED=0

          echo "" > clang-format.patch
          echo "" > clang-format.txt

          for file in $FILES; do
            diff_output=$(clang-format "$file" | diff -u "$file" - || true)

            if [[ -n "$diff_output" ]]; then
              echo "::error file=$file::clang-format issues detected"

              # Show colored diff in logs only
              echo -e "$diff_output" | colordiff || true

              # Save raw diff (no color) for PR comment
              echo -e "$diff_output" >> clang-format.txt

              # Save patch
              echo -e "$diff_output" >> clang-format.patch

              FAILED=1
            fi
          done

          echo "failed=$FAILED" >> "$GITHUB_OUTPUT"

      - name: Upload patch artifact
        if: steps.clang.outputs.failed == '1'
        uses: actions/upload-artifact@v4
        with:
          name: clang-format.patch
          path: clang-format.patch

      - name: Post inline review comments on PR
        if: steps.clang.outputs.failed == '1' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
        script: |
          const fs = require('fs');

          // 1. Read diff
          const diffText = fs.readFileSync('clang-format.patch', 'utf8').trim();
          if (!diffText) return;

          // 2. Split per file using --- headers (diff -u format)
          const fileChunks = diffText
            .split(/^--- /m)
            .slice(1)
            .map(chunk => '--- ' + chunk);

          // 3. Collect new review comments
          const rawComments = [];

          for (const chunk of fileChunks) {
            const lines = chunk.split('\n');

            // Extract filename
            const matchFile = lines[0].match(/^--- ["']?([^"\t]+)["']?\t/);
            if (!matchFile) continue;

            const filename = matchFile[1];
            let currentLine = 0;
            let hunkLines = [];

            for (const line of lines) {
              const hunkMatch = line.match(/^@@ -\d+(?:,\d+)? \+(\d+)(?:,(\d+))? @@/);
              if (hunkMatch) {
                // Close previous hunk if needed
                if (hunkLines.length > 0) {
                  rawComments.push({
                    path: filename,
                    line: hunkLines[0].line,
                    body: "clang-format changes:\n```\n" +
                          hunkLines.map(l => l.text).join("\n") +
                          "\n```"
                  });
                }
                // Start new hunk
                hunkLines = [];
                currentLine = parseInt(hunkMatch[1]);
                continue;
              }

              // Detect changed lines (+ but not +++)
              if (line.startsWith('+') && !line.startsWith('+++')) {
                hunkLines.push({
                  line: currentLine,
                  text: line
                });
                currentLine++;
                continue;
              }

              // Context line: end of a hunk, flush
              if (hunkLines.length > 0 && !line.startsWith('-')) {
                rawComments.push({
                  path: filename,
                  line: hunkLines[0].line,
                  body: "clang-format changes:\n```\n" +
                        hunkLines.map(l => l.text).join("\n") +
                        "\n```"
                });
                hunkLines = [];
              }

              if (!line.startsWith('-')) currentLine++;
            }

            // Flush final hunk
            if (hunkLines.length > 0) {
              rawComments.push({
                path: filename,
                line: hunkLines[0].line,
                body: "clang-format changes:\n```\n" +
                      hunkLines.map(l => l.text).join("\n") +
                      "\n```"
              });
            }
          }

          if (rawComments.length === 0) return;

          // 4. Avoid duplicate comments:
          const existing = await github.rest.pulls.listReviewComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: context.issue.number
          });

          const uniqueComments = rawComments.filter(c =>
            !existing.data.some(e =>
              e.path === c.path &&
              e.line === c.line &&
              e.body.trim() === c.body.trim()
            )
          );

          if (uniqueComments.length === 0) return;

          // 5. Create single review ("ALL")
          await github.rest.pulls.createReview({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: context.issue.number,
            event: 'REQUEST_CHANGES',
            body:
              "### clang-format detected issues\n" +
              "Inline comments were added. Please fix the formatting.\n\n" +
              "You can apply the formatting locally:\n" +
              "```bash\nclang-format -i <files>\n```\n" +
              "Or apply the patch in the CI artifacts.\n\n" +
              "See: `.clang-format` configuration.",
            comments: uniqueComments
          });

      - name: Fail job if necessary
        if: steps.clang.outputs.failed == '1'
        run: exit 1
